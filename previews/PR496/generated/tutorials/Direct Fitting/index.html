<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Direct Fitting · Korg</title><meta name="title" content="Direct Fitting · Korg"/><meta property="og:title" content="Direct Fitting · Korg"/><meta property="twitter:title" content="Direct Fitting · Korg"/><meta name="description" content="Documentation for Korg."/><meta property="og:description" content="Documentation for Korg."/><meta property="twitter:description" content="Documentation for Korg."/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script><link href="../../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.svg" alt="Korg logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Korg</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Quickstart</a></li><li><a class="tocitem" href="../../../install/">Install</a></li><li><a class="tocitem" href="../../../Upgrading/">Upgrading to v1.0</a></li><li><span class="tocitem">Guides</span><ul><li><a class="tocitem" href="../Basics/">Basics</a></li><li class="is-active"><a class="tocitem" href>Direct Fitting</a><ul class="internal"><li><a class="tocitem" href="#Linelist"><span>Linelist</span></a></li><li class="toplevel"><a class="tocitem" href="#Fitting-iron-lines-to-get-stellar-parameters"><span>Fitting iron lines to get stellar parameters</span></a></li><li class="toplevel"><a class="tocitem" href="#Fit-individual-abundances"><span>Fit individual abundances</span></a></li><li class="toplevel"><a class="tocitem" href="#Parameter-uncertainty"><span>Parameter uncertainty</span></a></li></ul></li><li><a class="tocitem" href="../Equivalent Widths/">Equivalent Widths</a></li><li><a class="tocitem" href="../Radial velocity precision/">Radial velocity precision</a></li><li><a class="tocitem" href="../../../tutorials/">Other Tutorials</a></li><li><a class="tocitem" href="../../../Abundances/">Abundances</a></li><li><a class="tocitem" href="../../../Wavelengths/">Wavelengths</a></li></ul></li><li><a class="tocitem" href="../../../API/">Public Functions</a></li><li><a class="tocitem" href="../../../FAQ/">FAQ</a></li><li><a class="tocitem" href="../../../devdocs/">Developer Documentation</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Guides</a></li><li class="is-active"><a href>Direct Fitting</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Direct Fitting</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/ajwheeler/Korg.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/ajwheeler/Korg.jl/blob/main/docs/src/Tutorials/Direct Fitting.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><p><a href="../Direct Fitting.ipynb">Download this page as a Jupyter notebook</a></p><p>In this example, we&#39;ll show how to use <a href="../../../API/#Korg.Fit.fit_spectrum"><code>Korg.Fit.fit_spectrum</code></a> to fit one of the spectra from <a href="https://ui.adsabs.harvard.edu/abs/2022arXiv221001821G">Griffith et al. 2022</a>. You will probably find it helpful to look at the <a href="https://ajwheeler.github.io/Korg.jl/stable/API/#Korg.Fit.fit_spectrum">documentation for this function</a> as well. For fitting equivalent widths (rather than spectra directly) see <a href="https://ajwheeler.github.io/Korg.jl/stable/API/#Korg.Fit.ews_to_abundances">the documentation for <code>Korg.Fit.ews_to_abundances</code></a>.</p><p>A quick disclaimer: this example is intended to demonstrate the usage of Korg&#39;s fitting functionality, not to be an ironclad spectral analysis.</p><p>We&#39;ll use a few packages in addition to Korg in this example. If you don&#39;t have them installed, you can run <code>using Pkg; Pkg.add([&quot;CSV&quot;, &quot;DataFrames&quot;, &quot;PyPlot&quot;])</code> to install them.</p><pre><code class="language-julia hljs">    using Korg, PythonPlot, CSV, DataFrames</code></pre><h1 id="Reading-in-the-data"><a class="docs-heading-anchor" href="#Reading-in-the-data">Reading in the data</a><a id="Reading-in-the-data-1"></a><a class="docs-heading-anchor-permalink" href="#Reading-in-the-data" title="Permalink"></a></h1><p>First, we need to read in the linelist, &quot;window list&quot; (the locations of lines to be fit), and spectrum. You can download the data files from Korg&#39;s GitHub repository at <a href="https://github.com/ajwheeler/Korg.jl/tree/v1.0.0/docs/src/assets/Griffith_2022">https://github.com/ajwheeler/Korg.jl/tree/v1.0.0/docs/src/assets/Griffith_2022</a>.</p><h2 id="Linelist"><a class="docs-heading-anchor" href="#Linelist">Linelist</a><a id="Linelist-1"></a><a class="docs-heading-anchor-permalink" href="#Linelist" title="Permalink"></a></h2><p>As in <a href="../Equivalent Widths/#EW_linelist">the Equivalent Widths Example</a>, we want to reproduce the results of a specific paper, so we&#39;ll use the linelist from that paper.</p><pre><code class="language-julia hljs">linetable = CSV.read(&quot;../../assets/Griffith_2022/lines.csv&quot;, DataFrame);
linelist = Korg.Line.(Korg.air_to_vacuum.(linetable.wave_A),
                      linetable.loggf,
                      Korg.Species.(linetable.element),
                      linetable.lower_state_eV,
                      linetable.rad,
                      linetable.stark,
                      linetable.waals)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">140292-element Vector{Korg.Line{Float64, Float64, Float64, Float64, Float64, Float64}}:
 Ti I 4201.202404 Å (log gf = -2.49, χ = 1.88 eV)
 Nd II 4201.205404 Å (log gf = -1.64, χ = 0.06 eV)
 W I 4201.211406 Å (log gf = -0.99, χ = 2.04 eV)
 U II 4201.269421 Å (log gf = -1.47, χ = 0.78 eV)
 Fe I 4201.270421 Å (log gf = -1.13, χ = 3.88 eV)
 Cr I 4201.284425 Å (log gf = -1.03, χ = 3.08 eV)
 Co I 4201.285425 Å (log gf = -1.01, χ = 4.07 eV)
 Fe II 4201.344441 Å (log gf = -3.65, χ = 7.73 eV)
 Cr I 4201.352443 Å (log gf = -0.86, χ = 3.84 eV)
 V I 4201.361445 Å (log gf = -2.29, χ = 0.28 eV)
 ⋮
 Fe I 9202.415925 Å (log gf = -6.33, χ = 5.38 eV)
 Mn I 9202.415925 Å (log gf = -5.62, χ = 4.35 eV)
 Fe II 9202.421927 Å (log gf = -2.72, χ = 12.76 eV)
 Mn II 9202.425928 Å (log gf = -1.66, χ = 13.44 eV)
 Mn II 9202.425928 Å (log gf = -0.71, χ = 13.44 eV)
 Mn II 9202.425928 Å (log gf = -0.25, χ = 13.44 eV)
 Mn II 9202.510951 Å (log gf = -1.62, χ = 13.44 eV)
 Mn II 9202.510951 Å (log gf = -0.73, χ = 13.44 eV)
 Mn II 9202.510951 Å (log gf = -0.4, χ = 13.44 eV)</code></pre><p>Next, we&#39;ll read in the &quot;window list&quot;, which provides wavelength ranges for features to be fit. We&#39;ll read this into a dictionary that maps atomic number to a vector of (lower, upper) wavelength bounds.</p><pre><code class="language-julia hljs">windowtable = CSV.File(&quot;../../assets/Griffith_2022/windows.tsv&quot;; delim=&#39;\t&#39;);
windows = Dict()
for row in windowtable
    #atomic number
    Z = Korg.get_atoms(Korg.Species(row.species))[1]
    #get the windows for this element so far
    wins = get(windows, Z, [])
    #add the new window
    push!(wins, (Korg.air_to_vacuum(row.wave_base * 10), Korg.air_to_vacuum(row.wave_top * 10)))
    #update the dictionary
    windows[Z] = wins
end</code></pre><p>Finally, read in the observed spectrum.</p><pre><code class="language-julia hljs">spec = CSV.read(&quot;../../assets/Griffith_2022/2MASS_J03443498+0553014.csv&quot;, DataFrame)
spec.waveobs = Korg.air_to_vacuum.(spec.waveobs * 10)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">27969-element Vector{Float64}:
 4222.237789574116
 4222.277860033124
 4222.317919782653
 4222.357968822494
 4222.398007152436
 4222.438034772281
 4222.47805168182
 4222.518057880852
 4222.558053369179
 4222.598038146595
    ⋮
 6318.009557531354
 6318.068451939513
 6318.127329935025
 6318.186191521686
 6318.245036703283
 6318.3038654835955
 6318.362677866404
 6318.421473855483
 6318.480253454593</code></pre><h1 id="Fitting-iron-lines-to-get-stellar-parameters"><a class="docs-heading-anchor" href="#Fitting-iron-lines-to-get-stellar-parameters">Fitting iron lines to get stellar parameters</a><a id="Fitting-iron-lines-to-get-stellar-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-iron-lines-to-get-stellar-parameters" title="Permalink"></a></h1><p>First, we&#39;ll provide an initial guess for each parameter we want to fit.</p><p>this is a &quot;NamedTuple&quot;, but you can also use a dictionary if you prefer</p><pre><code class="language-julia hljs">initial_guess = (; Teff=5400, logg=3.8, M_H=-1.1, vmic=1.0)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(Teff = 5400, logg = 3.8, M_H = -1.1, vmic = 1.0)</code></pre><p>Next, we&#39;ll fit the spectrum using only the iron line locations from <code>windows</code>. The object produced, <code>fit_result</code>, contains several bits of information, most importantly the best-fit parameters.</p><pre><code class="language-julia hljs">winds = windows[26] # use Fe windows
fit_result = Korg.Fit.fit_spectrum(spec.waveobs, spec.flux, spec.err, linelist, initial_guess;
                                   windows=winds, R=50_000)
fit_result.best_fit_params</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, Float64} with 4 entries:
  &quot;M_H&quot;  =&gt; -1.39496
  &quot;Teff&quot; =&gt; 5238.59
  &quot;logg&quot; =&gt; 3.652
  &quot;vmic&quot; =&gt; 0.804352</code></pre><p>It also contains the trace, which we can plot to see how the fit converged. Here&#39;s the <span>$\chi^2$</span> as a function of the optimizer step.</p><pre><code class="language-julia hljs">plot([t[&quot;chi2&quot;] for t in fit_result.trace])
ylabel(L&quot;χ^2&quot;)
xlabel(&quot;optimizer step&quot;)</code></pre><img src="6c1c2977.png" alt="Example block output"/><p>Here&#39;s the temperature as a function of the optimizer step.</p><pre><code class="language-julia hljs">plot([t[&quot;Teff&quot;] for t in fit_result.trace])
ylabel(L&quot;$T_\mathrm{eff}$ [K]&quot;)
xlabel(&quot;optimizer step&quot;)</code></pre><img src="f25948b2.png" alt="Example block output"/><p>The <code>fit_result</code> object also contains the best-fit spectrum, which we can plot in comparison to the observed one. Let&#39;s look at one of the iron lines.</p><p>get the observed spectrum only at the wavelengths within a fitting window</p><pre><code class="language-julia hljs">obs_wls = spec.waveobs[fit_result.obs_wl_mask]
obs_flux = spec.flux[fit_result.obs_wl_mask]
obs_err = spec.err[fit_result.obs_wl_mask]

w = rand(winds) # choose a window around a random Fe line</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(5416.404368510703, 5417.004528653171)</code></pre><p>create a bitmask to plot the window plus 1 Å on each side for context</p><pre><code class="language-julia hljs">mask = w[1] - 1 .&lt; obs_wls .&lt; w[2] + 1

scatter(obs_wls[mask], fit_result.best_fit_flux[mask]; c=&quot;r&quot;, label=&quot;Korg&quot;)
errorbar(obs_wls[mask], obs_flux[mask]; yerr=obs_err[mask], ls=&quot;&quot;, c=&quot;k&quot;, label=&quot;data&quot;)
legend()</code></pre><img src="fad44d5c.png" alt="Example block output"/><h1 id="Fit-individual-abundances"><a class="docs-heading-anchor" href="#Fit-individual-abundances">Fit individual abundances</a><a id="Fit-individual-abundances-1"></a><a class="docs-heading-anchor-permalink" href="#Fit-individual-abundances" title="Permalink"></a></h1><p>Now, let&#39;s fit for the sodium abundance, holding the stellar parameters fixed. We&#39;ll use the stellar parameters from Griffith, rather than the ones from the analysis above. Comparing the abundances you get using each is left as an exercise to the reader.</p><p>First, we&#39;ll define the initial guess for the Na abundance and the parameters to hold fixed.</p><pre><code class="language-julia hljs">init_params = (; Na=-1.0)
griffith_params = (Teff=5456, logg=3.86, M_H=-1.22, vsini=2.4, vmic=1.23)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(Teff = 5456, logg = 3.86, M_H = -1.22, vsini = 2.4, vmic = 1.23)</code></pre><p>Next, we&#39;ll fit the sodium lines. The only difference from how we called <code>fit_spectrum</code> the first time is that we pass in a second set of parameters to hold fixed. <a href="../../../API/#Korg.Fit.fit_spectrum"><code>Korg.Fit.fit_spectrum</code></a> supports any combination of parameters to fit and hold fixed.</p><pre><code class="language-julia hljs">winds = windows[11] # windows for Na (atomic number 11)
na_result = Korg.Fit.fit_spectrum(spec.waveobs, spec.flux, spec.err, linelist,
                                  init_params, griffith_params;
                                  R=50_000, windows=winds) # 11 is the atomic number of Na
na_result.best_fit_params[&quot;Na&quot;]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">-1.0927979511142638</code></pre><h1 id="Parameter-uncertainty"><a class="docs-heading-anchor" href="#Parameter-uncertainty">Parameter uncertainty</a><a id="Parameter-uncertainty-1"></a><a class="docs-heading-anchor-permalink" href="#Parameter-uncertainty" title="Permalink"></a></h1><p>Under the hood, <a href="../../../API/#Korg.Fit.fit_spectrum"><code>Korg.Fit.fit_spectrum</code></a> uses <a href="https://en.wikipedia.org/wiki/Limited-memory_BFGS">LBFGS</a> to find the best-fit parameters. That means it produces an estimate of the Hessian of the likelihood function, and thus the covariance matrix of the best-fit parameters.</p><pre><code class="language-julia hljs">fit_result.covariance</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">([&quot;M_H&quot;, &quot;Teff&quot;, &quot;logg&quot;, &quot;vmic&quot;], [4.8939932369956725e-6 0.005920107644798904 9.316413678504072e-6 2.4333691157712618e-6; 0.005920107644504544 8.325127294954378 0.012402415173368184 0.007420150573272199; 9.316413678379951e-6 0.012402415173370027 2.8117320862471628e-5 5.070182549107694e-6; 2.4333691157708383e-6 0.007420150573272203 5.070182549138289e-6 2.5825427837599046e-5])</code></pre><p>We caution the user that this is a very rough estimate, likely appropriate only for identifying pathological cases or the order of magnitude of the uncertainties.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Basics/">« Basics</a><a class="docs-footer-nextpage" href="../Equivalent Widths/">Equivalent Widths »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Friday 5 September 2025 14:18">Friday 5 September 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
